(function(global,factory){if(typeof define==='function'&&define.amd){define(['exports','react','prop-types','active-resource','underscore','classnames','shallowequal'],factory)}else if(typeof exports!=='undefined'){factory(exports,require('react'),require('prop-types'),require('active-resource'),require('underscore'),require('classnames'),require('shallowequal'))}else{var mod={exports:{}};factory(mod.exports,global.react,global.propTypes,global.activeResource,global.underscore,global.classnames,global.shallowequal);global.mitragyna=mod.exports}})(this,function(exports,_react,_propTypes,_activeResource,_underscore,_classnames,_shallowequal){'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Resource=exports.Field=exports.ErrorsFor=exports.Collection=undefined;var _react2=_interopRequireDefault(_react);var _propTypes2=_interopRequireDefault(_propTypes);var _activeResource2=_interopRequireDefault(_activeResource);var _underscore2=_interopRequireDefault(_underscore);var _classnames2=_interopRequireDefault(_classnames);var _shallowequal2=_interopRequireDefault(_shallowequal);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Collection=exports.Collection=function(_React$PureComponent){_inherits(Collection,_React$PureComponent);// link to global state by enabling afterLoad, afterAdd, afterRemove, afterUpdate callbacks that can call
// an action linked to dispatch
function Collection(){_classCallCheck(this,Collection);var _this=_possibleConstructorReturn(this,(Collection.__proto__||Object.getPrototypeOf(Collection)).call(this));_this.state={loading:true,target:_activeResource2.default.prototype.Collection.build()};_underscore2.default.bindAll(_this,'buildOnTarget','cloneTarget','replaceOnTarget','removeFromTarget');return _this}_createClass(Collection,[{key:'componentDidMount',value:function componentDidMount(){this.setTarget(this.props)}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(nextProps){this.setTarget(nextProps)}},{key:'setTarget',value:function setTarget(props){var _this2=this;var subject=props.subject;var isRelationship=subject.isA(_activeResource2.default.prototype.Associations.prototype.CollectionProxy);var setLoadedTarget=function setLoadedTarget(target){_this2.setState({loading:false,target:target})};if(isRelationship){if(subject.base.loaded()){setLoadedTarget(subject.base.target)}else{subject.load().then(setLoadedTarget)}}else if(!_underscore2.default.isUndefined(subject.all)){subject.all().then(setLoadedTarget)}}},{key:'buildOnTarget',value:function buildOnTarget(attributes){var subject=this.props.subject;var target=this.cloneTarget();target.push(subject.build(attributes));this.setState({target:target})}},{key:'replaceOnTarget',value:function replaceOnTarget(newItem,oldItem){var target=this.cloneTarget();target.replace(oldItem,newItem);return this.setState({target:target})}},{key:'removeFromTarget',value:function removeFromTarget(item){var target=this.cloneTarget();target.delete(item);return this.setState({target:target})}},{key:'cloneTarget',value:function cloneTarget(){return this.state.target.clone()}},{key:'render',value:function render(){var _this3=this;var _props=this.props,blankComponent=_props.blankComponent,children=_props.children,className=_props.className,component=_props.component,componentProps=_props.componentProps,reflection=_props.reflection;var _state=this.state,loading=_state.loading,target=_state.target;return _react2.default.createElement('section',{className:className},loading?_react2.default.createElement('span',null,'Loading'):target.size()>0?target.map(function(t,index){return _react2.default.createElement(Resource,{afterUpdate:_this3.replaceOnTarget,component:component,componentProps:componentProps,key:t.id||t.klass().className+'-'+index,reflection:reflection,subject:t},children)}).toArray():blankComponent!=null&&blankComponent())}}]);return Collection}(_react2.default.PureComponent);Collection.propTypes={children:_propTypes2.default.oneOfType([_propTypes2.default.array,_propTypes2.default.node]),className:_propTypes2.default.string,blankComponent:_propTypes2.default.func,component:_propTypes2.default.func,componentProps:_propTypes2.default.object,subject:_propTypes2.default.oneOfType([_propTypes2.default.object,_propTypes2.default.func]).isRequired,reflection:_propTypes2.default.string};Collection.defaultProps={inlineRows:false};var ErrorsFor=exports.ErrorsFor=function(_React$Component){_inherits(ErrorsFor,_React$Component);function ErrorsFor(){_classCallCheck(this,ErrorsFor);return _possibleConstructorReturn(this,(ErrorsFor.__proto__||Object.getPrototypeOf(ErrorsFor)).apply(this,arguments))}_createClass(ErrorsFor,[{key:'shouldComponentUpdate',value:function shouldComponentUpdate(nextProps,nextState,nextContext){return!((0,_shallowequal2.default)(this.props,nextProps)&&(0,_shallowequal2.default)(this.state,nextState)&&(0,_shallowequal2.default)(this.context,nextContext))}},{key:'render',value:function render(){var resource=this.context.resource;var _props2=this.props,component=_props2.component,field=_props2.field;var errors=resource.errors().forField(field);if(errors.empty())return null;var customProps=_underscore2.default.omit(this.props,_underscore2.default.keys(ErrorsFor.propTypes));var finalComponent=component||'summary';return _react2.default.createElement(finalComponent,_extends({},customProps,{key:field}),errors.map(function(error){return _react2.default.createElement('span',{key:error.code},error.message)}).toArray())}}]);return ErrorsFor}(_react2.default.Component);ErrorsFor.propTypes={component:_propTypes2.default.func,field:_propTypes2.default.string};ErrorsFor.contextTypes={resource:_propTypes2.default.object};;var Field=exports.Field=function(_React$Component2){_inherits(Field,_React$Component2);function Field(){_classCallCheck(this,Field);var _this5=_possibleConstructorReturn(this,(Field.__proto__||Object.getPrototypeOf(Field)).call(this));_underscore2.default.bindAll(_this5,'classNames','commonInputProps','handleChange','handleUpdate','renderCheckboxComponent','renderInputComponent','renderRadioComponent','renderSelectComponent','renderTextareaComponent');return _this5}_createClass(Field,[{key:'shouldComponentUpdate',value:function shouldComponentUpdate(nextProps,nextState,nextContext){return!((0,_shallowequal2.default)(this.props,nextProps)&&(0,_shallowequal2.default)(this.state,nextState)&&(0,_shallowequal2.default)(this.context,nextContext))}},{key:'componentWillMount',value:function componentWillMount(){var resource=this.context.resource;// Set initial value to that of the resources
this.setState({value:this.valueFor(resource,this.props)})}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(nextProps,nextContext){var resource=nextContext.resource;this.setState({value:this.valueFor(resource,nextProps)})}},{key:'classNames',value:function classNames(){var _props3=this.props,className=_props3.className,invalidClassName=_props3.invalidClassName,name=_props3.name;var resource=this.context.resource;return(0,_classnames2.default)(className,_defineProperty({},invalidClassName,!resource.errors().forField(name).empty()))}},{key:'commonInputProps',value:function commonInputProps(){var name=this.props.name;return{className:this.classNames(),key:name,onBlur:this.handleUpdate,onChange:this.handleChange}}},{key:'componentFor',value:function componentFor(type){switch(type){case'checkbox':return this.renderCheckboxComponent();case'radio':return this.renderRadioComponent();case'select':return this.renderSelectComponent();case'textarea':return this.renderTextareaComponent();default:return this.renderInputComponent();}}// TODO: Add support for non-resource options on select and radio
},{key:'valueFor',value:function valueFor(resource,props){var name=props.name,type=props.type,uncheckedValue=props.uncheckedValue,value=props.value;switch(type){case'checkbox':var resourceValue=resource[name];if(resourceValue==value){return true}else if(resourceValue==uncheckedValue||_underscore2.default.isUndefined(resourceValue)||_underscore2.default.isNull(resourceValue)){return false}else{throw'Field '+name+' with value '+resource[name]+' does not match value or uncheckedValue for checkbox'}case'radio':case'select':var val=resource[name]();return val?val.id:'';default:var val=resource[name];return!_underscore2.default.isUndefined(val)&&!_underscore2.default.isNull(val)?resource[name]:'';}}},{key:'render',value:function render(){var type=this.props.type;return this.componentFor(type)}},{key:'renderCheckboxComponent',value:function renderCheckboxComponent(){var _props4=this.props,component=_props4.component,name=_props4.name;var checkboxProps=_underscore2.default.omit(this.props,_underscore2.default.keys(_underscore2.default.omit(Field.propTypes,'type')));var finalComponent=component||'input';return _react2.default.createElement(finalComponent,_extends({},checkboxProps,this.commonInputProps(),{checked:this.state.value}))}},{key:'renderInputComponent',value:function renderInputComponent(){var _props5=this.props,component=_props5.component,name=_props5.name;var inputProps=_underscore2.default.omit(this.props,_underscore2.default.keys(_underscore2.default.omit(Field.propTypes,'type')));var finalComponent=component||'input';return _react2.default.createElement(finalComponent,_extends({},inputProps,this.commonInputProps(),{value:this.state.value}))}},{key:'renderRadioComponent',value:function renderRadioComponent(){var _props6=this.props,component=_props6.component,name=_props6.name,value=_props6.value;var fieldValue=this.state.value;if(_underscore2.default.isUndefined(value)){throw'Input type="radio" must have prop "value"'}var radioProps=_underscore2.default.omit(this.props,_underscore2.default.keys(_underscore2.default.omit(Field.propTypes,'type')));var finalComponent=component||'input';return _react2.default.createElement(finalComponent,_extends({},radioProps,this.commonInputProps(),{checked:value.id==fieldValue,value:value.id}))}},{key:'renderSelectComponent',value:function renderSelectComponent(){var _props7=this.props,component=_props7.component,includeBlank=_props7.includeBlank,name=_props7.name,options=_props7.options,optionsLabel=_props7.optionsLabel;var selectOptions=null;if(options.empty()){throw'Input type="select" must have options'}else{selectOptions=options.map(function(o){return _react2.default.createElement('option',{key:o.id,value:o.id},_underscore2.default.isString(optionsLabel)?o[optionsLabel]:optionsLabel(o))});if(includeBlank){selectOptions.unshift(_react2.default.createElement('option',{key:-1,value:''}))}}var omittedKeys=component?_underscore2.default.omit(Field.propTypes,'type'):Field.propTypes;var selectProps=_underscore2.default.omit(this.props,_underscore2.default.keys(omittedKeys));var finalComponent=component||'select';return _react2.default.createElement(finalComponent,_extends({},selectProps,this.commonInputProps(),{value:this.state.value}),selectOptions.toArray())}},{key:'renderTextareaComponent',value:function renderTextareaComponent(){var _props8=this.props,component=_props8.component,name=_props8.name;var textareaProps=_underscore2.default.omit(this.props,_underscore2.default.keys(_underscore2.default.omit(Field.propTypes,'type')));var finalComponent=component||'textarea';return _react2.default.createElement(finalComponent,_extends({},textareaProps,this.commonInputProps(),{value:this.state.value}))}},{key:'handleChange',value:function handleChange(e){e.persist();var type=this.props.type;var value=void 0;switch(type){case'checkbox':value=e.target.checked;break;default:value=e.target.value;}this.setState({value:value})}},{key:'handleUpdate',value:function handleUpdate(e){e.persist();var _context=this.context,afterUpdate=_context.afterUpdate,resource=_context.resource;var _props9=this.props,name=_props9.name,type=_props9.type,options=_props9.options,uncheckedValue=_props9.uncheckedValue,value=_props9.value;var newValue=e.target.value;switch(type){case'checkbox':if(e.target.checked){newValue=value}else{newValue=uncheckedValue}break;case'radio':newValue=value;break;case'select':newValue=options.detect(function(o){return o.id===newValue});break;}afterUpdate(resource.assignAttributes(_defineProperty({},name,newValue)))}}]);return Field}(_react2.default.Component);Field.contextTypes={afterUpdate:_propTypes2.default.func,resource:_propTypes2.default.object};Field.propTypes={className:_propTypes2.default.string,component:_propTypes2.default.func,includeBlank:_propTypes2.default.bool,name:_propTypes2.default.string.isRequired,options:_propTypes2.default.instanceOf(_activeResource2.default.Collection),optionsLabel:_propTypes2.default.oneOfType([_propTypes2.default.string,_propTypes2.default.func]),type:_propTypes2.default.string.isRequired,uncheckedValue:_propTypes2.default.oneOfType([_propTypes2.default.object,_propTypes2.default.func,_propTypes2.default.string,_propTypes2.default.number]),invalidClassName:_propTypes2.default.string,value:_propTypes2.default.oneOfType([_propTypes2.default.object,_propTypes2.default.func,_propTypes2.default.string,_propTypes2.default.number])};var Resource=exports.Resource=function(_React$PureComponent2){_inherits(Resource,_React$PureComponent2);function Resource(props,context){_classCallCheck(this,Resource);var _this6=_possibleConstructorReturn(this,(Resource.__proto__||Object.getPrototypeOf(Resource)).call(this));_underscore2.default.bindAll(_this6,'afterUpdate','handleSubmit','updateRoot');var root=context.root;var reflection=props.reflection,subject=props.subject;var state={resource:subject};if(reflection){var reflectionInstance=root.klass().reflectOnAssociation(reflection);if(_underscore2.default.isUndefined(reflectionInstance))throw'Reflection '+reflection+' not found.';var inverseReflection=reflectionInstance.inverseOf();if(_underscore2.default.isUndefined(inverseReflection))throw'Reflection '+reflection+' must have inverse.';state=_extends({},state,{inverseReflection:inverseReflection,reflection:reflectionInstance})}_this6.state=state;return _this6}_createClass(Resource,[{key:'componentWillReceiveProps',value:function componentWillReceiveProps(nextProps){this.setState({resource:nextProps.subject})}},{key:'componentDidCatch',value:function componentDidCatch(error){return _react2.default.createElement('p',null,error)}},{key:'afterUpdate',value:function afterUpdate(newResource){var _context2=this.context,root=_context2.root,updateRoot=_context2.updateRoot;var _state2=this.state,inverseReflection=_state2.inverseReflection,resource=_state2.resource;if(inverseReflection){var oldTarget=resource.association(inverseReflection.name).target;var newTarget=newResource.association(inverseReflection.name).target;if(inverseReflection.collection()){// FIXME: Allow autosave inverseOf collection to appropriately handle multiple resources in the collection,
//   not just the first. If changing multiple fields of resource quickly, root may not be found in oldTarget
//   because it has already been replaced by a previous change
// var index = oldTarget.indexOf(root);
// var newRoot = newTarget.get(index);
updateRoot(newTarget.first())}else{updateRoot(newTarget)}}else{this.updateRoot(newResource)}}},{key:'getChildContext',value:function getChildContext(){var root=this.context.root;var resource=this.state.resource;var childContext={afterUpdate:this.afterUpdate,isNestedResource:true,root:root||resource,resource:resource,updateRoot:this.updateRoot};return childContext}},{key:'handleSubmit',value:function handleSubmit(e){e.preventDefault();var _props10=this.props,onSubmit=_props10.onSubmit,onInvalidSubmit=_props10.onInvalidSubmit;var resource=this.state.resource;var onSubmitCallback=function onSubmitCallback(resourceToSubmit){if(!_underscore2.default.isUndefined(onSubmit)){onSubmit(resourceToSubmit)}};var onInvalidSubmitCallback=function onInvalidSubmitCallback(invalidResource){if(!_underscore2.default.isUndefined(onInvalidSubmit)){onInvalidSubmit(invalidResource)}};if(!_underscore2.default.isUndefined(this.componentRef.beforeSubmit)){Promise.resolve(this.componentRef.beforeSubmit(resource)).then(onSubmitCallback).catch(onInvalidSubmitCallback)}else{onSubmitCallback(resource)}}},{key:'render',value:function render(){var _this7=this;var isNestedResource=this.context.isNestedResource;var _props11=this.props,afterError=_props11.afterError,children=_props11.children,className=_props11.className,component=_props11.component,componentProps=_props11.componentProps;var resource=this.state.resource;var body=void 0;if(component){body=_react2.default.createElement(component,_extends({},componentProps,{afterUpdate:this.afterUpdate,afterError:afterError,subject:resource,ref:function ref(c){_this7.componentRef=c}}))}else{body=children}if(isNestedResource){return _react2.default.createElement('section',{className:className},body)}else{return _react2.default.createElement('form',{className:className,onSubmit:this.handleSubmit},body)}}},{key:'updateRoot',value:function updateRoot(newRoot){var _this8=this;var fromSave=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var afterUpdate=this.props.afterUpdate;var resource=this.state.resource;this.setState({resource:newRoot});if(!_underscore2.default.isUndefined(afterUpdate))afterUpdate(newRoot,resource);if(!fromSave){newRoot.save(function(root){return _this8.updateRoot(root,true)})}}}]);return Resource}(_react2.default.PureComponent);Resource.propTypes={afterError:_propTypes2.default.func,afterUpdate:_propTypes2.default.func,children:_propTypes2.default.oneOfType([_propTypes2.default.array,_propTypes2.default.node]),className:_propTypes2.default.string,component:_propTypes2.default.func,componentProps:_propTypes2.default.object,onInvalidSubmit:_propTypes2.default.func,onSubmit:_propTypes2.default.func,reflection:_propTypes2.default.string,subject:_propTypes2.default.object.isRequired};Resource.contextTypes={isNestedResource:_propTypes2.default.bool,root:_propTypes2.default.object,updateRoot:_propTypes2.default.func};Resource.childContextTypes={afterUpdate:_propTypes2.default.func,isNestedResource:_propTypes2.default.bool,resource:_propTypes2.default.object,root:_propTypes2.default.object,updateRoot:_propTypes2.default.func};Resource.defaultProps={componentProps:{}}});
//# sourceMappingURL=mitragyna.min.js.map
