(function(global,factory){if(typeof define==='function'&&define.amd){define(['exports','react','prop-types','active-resource','underscore'],factory)}else if(typeof exports!=='undefined'){factory(exports,require('react'),require('prop-types'),require('active-resource'),require('underscore'))}else{var mod={exports:{}};factory(mod.exports,global.react,global.propTypes,global.activeResource,global.underscore);global.mitragyna=mod.exports}})(this,function(exports,_react,_propTypes,_activeResource,_underscore){'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Resource=exports.Field=exports.ErrorsFor=exports.Collection=undefined;var _react2=_interopRequireDefault(_react);var _propTypes2=_interopRequireDefault(_propTypes);var _activeResource2=_interopRequireDefault(_activeResource);var _underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Collection=exports.Collection=function(_React$PureComponent){_inherits(Collection,_React$PureComponent);// link to global state by enabling afterLoad, afterAdd, afterRemove, afterUpdate callbacks that can call
// an action linked to dispatch
function Collection(){_classCallCheck(this,Collection);var _this=_possibleConstructorReturn(this,(Collection.__proto__||Object.getPrototypeOf(Collection)).call(this));_this.state={loading:true,target:_activeResource2.default.prototype.Collection.build()};_underscore2.default.bindAll(_this,'buildOnTarget','cloneTarget','replaceOnTarget','removeFromTarget');return _this}_createClass(Collection,[{key:'componentDidMount',value:function componentDidMount(){this.setTarget(this.props)}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(nextProps){this.setTarget(nextProps)}},{key:'setTarget',value:function setTarget(props){var _this2=this;var subject=props.subject;var isRelationship=subject.isA(_activeResource2.default.prototype.Associations.prototype.CollectionProxy);var setLoadedTarget=function setLoadedTarget(target){_this2.setState({loading:false,target:target})};if(isRelationship){if(subject.base.loaded()){setLoadedTarget(subject.base.target)}else{subject.load().then(setLoadedTarget)}}else if(!_underscore2.default.isUndefined(subject.all)){subject.all().then(setLoadedTarget)}}},{key:'buildOnTarget',value:function buildOnTarget(attributes){var subject=this.props.subject;var target=this.cloneTarget();target.push(subject.build(attributes));this.setState({target:target})}},{key:'replaceOnTarget',value:function replaceOnTarget(newItem,oldItem){var target=this.cloneTarget();target.replace(oldItem,newItem);return this.setState({target:target})}},{key:'removeFromTarget',value:function removeFromTarget(item){var target=this.cloneTarget();target.delete(item);return this.setState({target:target})}},{key:'cloneTarget',value:function cloneTarget(){return this.state.target.clone()}},{key:'render',value:function render(){var _this3=this;var _props=this.props,blankComponent=_props.blankComponent,children=_props.children,className=_props.className,component=_props.component;var _state=this.state,loading=_state.loading,target=_state.target;return _react2.default.createElement('section',{className:className},loading?_react2.default.createElement('span',null,'Loading'):target.size()>0?target.map(function(t){return _react2.default.createElement(Resource,{subject:t,key:t.localId,component:component,afterUpdate:_this3.replaceOnTarget},children)}).toArray():blankComponent!=null&&blankComponent())}}]);return Collection}(_react2.default.PureComponent);Collection.propTypes={children:_propTypes2.default.oneOfType([_propTypes2.default.array,_propTypes2.default.node]),className:_propTypes2.default.string,blankComponent:_propTypes2.default.func,component:_propTypes2.default.func,subject:_propTypes2.default.oneOfType([_propTypes2.default.object,_propTypes2.default.func]).isRequired};Collection.defaultProps={inlineRows:false};var ErrorsFor=exports.ErrorsFor=function(_React$PureComponent2){_inherits(ErrorsFor,_React$PureComponent2);function ErrorsFor(){_classCallCheck(this,ErrorsFor);return _possibleConstructorReturn(this,(ErrorsFor.__proto__||Object.getPrototypeOf(ErrorsFor)).apply(this,arguments))}_createClass(ErrorsFor,[{key:'render',value:function render(){var root=this.context.root;var field=this.props.field;if(_underscore2.default.size(root.errors().forField(field))<1){return null}return _react2.default.createElement('summary',null,_underscore2.default.map(root.errors().forField(field),function(message,code){return _react2.default.createElement('p',{key:code},message)}))}}]);return ErrorsFor}(_react2.default.PureComponent);ErrorsFor.propTypes={field:_propTypes2.default.string};ErrorsFor.contextTypes={root:_propTypes2.default.object};;var Field=exports.Field=function(_React$PureComponent3){_inherits(Field,_React$PureComponent3);function Field(){_classCallCheck(this,Field);var _this5=_possibleConstructorReturn(this,(Field.__proto__||Object.getPrototypeOf(Field)).call(this));_underscore2.default.bindAll(_this5,'handleChange','handleUpdate','renderInputComponent','renderRadioComponent','renderSelectComponent','renderTextareaComponent');return _this5}_createClass(Field,[{key:'componentWillMount',value:function componentWillMount(){var _props2=this.props,name=_props2.name,type=_props2.type;var resource=this.context.resource;// Set initial value to that of the resources
this.setState({value:this.valueFor(type,resource,name)})}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(nextProps,nextContext){var name=nextProps.name,type=nextProps.type;var resource=nextContext.resource;this.setState({value:this.valueFor(type,resource,name)})}// TODO: Add support for non-resource options on select and radio
},{key:'valueFor',value:function valueFor(type,resource,name){var val=resource[name];switch(type){case'radio':case'select':val=val();return _underscore2.default.isNull(val)?'':val.id;default:return val||'';}}},{key:'componentFor',value:function componentFor(type){switch(type){case'radio':return this.renderRadioComponent();case'select':return this.renderSelectComponent();case'textarea':return this.renderTextareaComponent();default:return this.renderInputComponent();}}},{key:'render',value:function render(){var type=this.props.type;return this.componentFor(type)}},{key:'renderInputComponent',value:function renderInputComponent(){var _props3=this.props,component=_props3.component,name=_props3.name;var inputProps=_underscore2.default.omit(this.props,_underscore2.default.keys(_underscore2.default.omit(Field.propTypes,'type')));var finalComponent=component||'input';return _react2.default.createElement(finalComponent,_extends({},inputProps,{key:name,onBlur:this.handleUpdate,onChange:this.handleChange,value:this.state.value}))}},{key:'renderRadioComponent',value:function renderRadioComponent(){var _props4=this.props,component=_props4.component,name=_props4.name,value=_props4.value;var fieldValue=this.state.value;if(_underscore2.default.isUndefined(value)){throw'Input type="radio" must have prop "value"'}var radioProps=_underscore2.default.omit(this.props,_underscore2.default.keys(_underscore2.default.omit(Field.propTypes,'type')));var finalComponent=component||'input';return _react2.default.createElement(finalComponent,_extends({},radioProps,{checked:value.id==fieldValue,key:name,onBlur:this.handleUpdate,onChange:this.handleChange,value:value.id}))}},{key:'renderSelectComponent',value:function renderSelectComponent(){var _props5=this.props,component=_props5.component,includeBlank=_props5.includeBlank,name=_props5.name,options=_props5.options,optionsLabelKey=_props5.optionsLabelKey;var selectOptions=null;if(options.isEmpty()){throw'Input type="select" must have options'}else{selectOptions=options.map(function(o){return _react2.default.createElement('option',{key:o.localId,value:o.id},o[optionsLabelKey])});if(includeBlank){selectOptions=selectOptions.unshift(_react2.default.createElement('option',{key:-1,value:''}))}}var omittedKeys=component?_underscore2.default.omit(Field.propTypes,'type'):Field.propTypes;var selectProps=_underscore2.default.omit(this.props,_underscore2.default.keys(omittedKeys));var finalComponent=component||'select';return _react2.default.createElement(finalComponent,_extends({},selectProps,{key:name,onBlur:this.handleUpdate,onChange:this.handleChange,value:this.state.value}),selectOptions.toArray())}},{key:'renderTextareaComponent',value:function renderTextareaComponent(){var _props6=this.props,component=_props6.component,name=_props6.name;var textareaProps=_underscore2.default.omit(this.props,_underscore2.default.keys(Field.propTypes));var finalComponent=component||'textarea';return _react2.default.createElement(finalComponent,_extends({},textareaProps,{key:name,onBlur:this.handleUpdate,onChange:this.handleChange,value:this.state.value}))}},{key:'handleChange',value:function handleChange(e){e.persist();this.setState({value:e.target.value})}},{key:'handleUpdate',value:function handleUpdate(e){e.persist();var _context=this.context,afterUpdate=_context.afterUpdate,resource=_context.resource;var _props7=this.props,name=_props7.name,type=_props7.type,options=_props7.options,value=_props7.value;var newValue=e.target.value;switch(type){case'radio':newValue=value;break;case'select':newValue=options.detect(function(o){return o.id===newValue});break;}afterUpdate(resource.assignAttributes(_defineProperty({},name,newValue)))}}]);return Field}(_react2.default.PureComponent);Field.contextTypes={afterUpdate:_propTypes2.default.func,resource:_propTypes2.default.object};Field.propTypes={component:_propTypes2.default.func,includeBlank:_propTypes2.default.bool,name:_propTypes2.default.string.isRequired,options:_propTypes2.default.instanceOf(_activeResource2.default.Collection),optionsLabelKey:_propTypes2.default.string,type:_propTypes2.default.string.isRequired,value:_propTypes2.default.oneOfType([_propTypes2.default.func,_propTypes2.default.string,_propTypes2.default.number])};var Resource=exports.Resource=function(_React$PureComponent4){_inherits(Resource,_React$PureComponent4);function Resource(props,context){_classCallCheck(this,Resource);var _this6=_possibleConstructorReturn(this,(Resource.__proto__||Object.getPrototypeOf(Resource)).call(this));_underscore2.default.bindAll(_this6,'afterUpdate','handleSubmit','updateRoot');var root=context.root;var reflection=props.reflection,subject=props.subject;var state={resource:subject};if(reflection){var reflectionInstance=root.klass().reflectOnAssociation(reflection);if(_underscore2.default.isUndefined(reflectionInstance))throw'Reflection '+reflection+' not found.';var inverseReflection=reflectionInstance.inverseOf();if(_underscore2.default.isUndefined(inverseReflection))throw'Reflection '+reflection+' must have inverse.';state=_extends({},state,{inverseReflection:inverseReflection,reflection:reflectionInstance})}_this6.state=state;return _this6}_createClass(Resource,[{key:'componentWillReceiveProps',value:function componentWillReceiveProps(nextProps){this.setState({resource:nextProps.subject})}},{key:'componentDidCatch',value:function componentDidCatch(error){return _react2.default.createElement('p',null,error)}},{key:'afterUpdate',value:function afterUpdate(newResource){var _context2=this.context,root=_context2.root,updateRoot=_context2.updateRoot;var _state2=this.state,inverseReflection=_state2.inverseReflection,resource=_state2.resource;if(inverseReflection){var oldTarget=resource.association(inverseReflection.name).target;var newTarget=newResource.association(inverseReflection.name).target;if(inverseReflection.collection()){// FIXME: Allow autosave inverseOf collection to appropriately handle multiple resources in the collection,
//   not just the first. If changing multiple fields of resource quickly, root may not be found in oldTarget
//   because it has already been replaced by a previous change
// var index = oldTarget.indexOf(root);
// var newRoot = newTarget.get(index);
updateRoot(newTarget.first())}else{updateRoot(target)}}else{this.updateRoot(newResource)}}},{key:'getChildContext',value:function getChildContext(){var root=this.context.root;var resource=this.state.resource;var childContext={afterUpdate:this.afterUpdate,isNestedResource:true,root:root||resource,resource:resource,updateRoot:this.updateRoot};return childContext}},{key:'handleSubmit',value:function handleSubmit(e){var onSubmit=this.props.onSubmit;var resource=this.state.resource;if(!_underscore2.default.isUndefined(onSubmit)){e.preventDefault();onSubmit(resource)}}},{key:'render',value:function render(){var isNestedResource=this.context.isNestedResource;var _props8=this.props,children=_props8.children,className=_props8.className,component=_props8.component,componentProps=_props8.componentProps;var resource=this.state.resource;var body=null;if(component){body=_react2.default.createElement(component,_extends({},componentProps,{afterUpdate:this.afterUpdate,subject:resource}))}else{body=children}if(!isNestedResource){body=_react2.default.createElement('form',{onSubmit:this.handleSubmit},body)}return _react2.default.createElement('section',{className:className},body)}},{key:'updateRoot',value:function updateRoot(newRoot){var _this7=this;var fromSave=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var afterUpdate=this.props.afterUpdate;var resource=this.state.resource;this.setState({resource:newRoot});if(!_underscore2.default.isUndefined(afterUpdate))afterUpdate(newRoot,resource);if(!fromSave){newRoot.save(function(root){return _this7.updateRoot(root,true)})}}}]);return Resource}(_react2.default.PureComponent);Resource.propTypes={afterUpdate:_propTypes2.default.func,children:_propTypes2.default.oneOfType([_propTypes2.default.array,_propTypes2.default.node]),className:_propTypes2.default.string,component:_propTypes2.default.func,componentProps:_propTypes2.default.object,onSubmit:_propTypes2.default.func,reflection:_propTypes2.default.string,subject:_propTypes2.default.object.isRequired};Resource.contextTypes={isNestedResource:_propTypes2.default.bool,root:_propTypes2.default.object,updateRoot:_propTypes2.default.func};Resource.childContextTypes={afterUpdate:_propTypes2.default.func,isNestedResource:_propTypes2.default.bool,resource:_propTypes2.default.object,root:_propTypes2.default.object,updateRoot:_propTypes2.default.func};Resource.defaultProps={componentProps:{}}});
//# sourceMappingURL=mitragyna.min.js.map
